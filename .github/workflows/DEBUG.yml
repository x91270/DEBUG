name: DEBUG
on:
  watch:
    types: started
jobs:
  Ubuntu:
    runs-on: ubuntu-latest
    steps:
    - name: Install tmate on Ubuntu
      run: |
        curl -fsSL git.io/tmate.sh | bash
        [ -e ~/.ssh/id_rsa ] || ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ""
        
    - name: Running tmate...
      run: |
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready    
        
    - name: To connect to this session copy-n-paste the following into a terminal or browser
      run: |
        tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
        tmate -S /tmp/tmate.sock display -p '#{tmate_web}'
        sleep 30
        if [[ ! -z "$SLACK_WEBHOOK_URL" ]]; then
          MSG=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"\`$MSG\`\"}" $SLACK_WEBHOOK_URL
        fi
             
    - name: Wait for connection to close in 350 min
      run: |
        timeout=$((350*60))
        while [ -S /tmp/tmate.sock ]; do
          sleep 1
          timeout=$(($timeout-1))

          if (( timeout < 0 )); then
            echo Waiting on tmate connection timed out!
            sudo init 0
          fi
        done
